<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ì–∞–º–∞–Ω–µ—Ü—å</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div class="wallet-container">
        <h1>üíº –ü—Ä–æ—Ñ—ñ–ª—å –≥–∞–º–∞–Ω—Ü—è</h1>
        <div id="wallet-info">
            <p><strong>Seed-—Ñ—Ä–∞–∑–∞:</strong> <span id="seed-display">‚è≥</span></p>
            <div id="address-list"></div>
            <p><strong>–ó–∞–≥–∞–ª—å–Ω–∏–π –±–∞–ª–∞–Ω—Å (ETH):</strong> <span id="total-eth">‚è≥</span></p>
        </div>
    </div>

    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- bip39 as ES module -->
    <script type="module">
        import * as bip39Module from "https://cdn.jsdelivr.net/npm/bip39@3.0.4/dist/bip39.browser.min.js";
        window.bip39 = bip39Module;
        window.bip39_ready = true;
        console.log("‚úÖ bip39 —É—Å–ø—ñ—à–Ω–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ");
    </script>

    <!-- –û—Å–Ω–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞ -->
    <script>
        const seedDisplay = document.getElementById("seed-display");
        const totalEthElem = document.getElementById("total-eth");
        const addressList = document.getElementById("address-list");

        async function waitForBip39() {
            let retries = 0;
            while (!window.bip39_ready && retries < 20) {
                await new Promise((r) => setTimeout(r, 250));
                retries++;
            }
            if (!window.bip39_ready) {
                console.error("‚ùå bip39 –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –Ω–∞–≤—ñ—Ç—å –ø—ñ—Å–ª—è –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è");
                return false;
            }
            return true;
        }

        async function deriveAddresses(mnemonic) {
            console.log("üîë –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∞–¥—Ä–µ—Å –∑ —Ñ—Ä–∞–∑–∏:", mnemonic);
            const seed = await window.bip39.mnemonicToSeed(mnemonic);
            const root = bitcoin.bip32.fromSeed(seed);
            const ethNode = root.derivePath("m/44'/60'/0'/0/0");
            const address = "0x" + ethNode.publicKey.toString('hex').slice(0, 40);
            const el = document.createElement("p");
            el.innerText = `ETH: ${address}`;
            addressList.appendChild(el);
        }

        async function calculateTotalETH() {
            totalEthElem.innerText = "0.0000";
        }

        document.addEventListener("DOMContentLoaded", async () => {
            console.log("üöÄ DOM –ø–æ–≤–Ω—ñ—Å—Ç—é –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ");

            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();

            const dataStr = tg.initDataUnsafe?.user?.id ? tg.initData : tg.initDataUnsafe?.data;
            if (!dataStr) return alert("‚ùå –î–∞–Ω—ñ –Ω–µ –æ—Ç—Ä–∏–º–∞–Ω–æ");

            let payload;
            try {
                payload = JSON.parse(dataStr);
            } catch (err) {
                console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É –¥–∞–Ω–∏—Ö:", err);
                return;
            }

            const seed = payload.seed || "‚ùì";
            seedDisplay.innerText = seed;

            if (await waitForBip39()) {
                await deriveAddresses(seed);
                await calculateTotalETH();
            }
        });
    </script>

    <!-- bitcoinjs-lib for bip32 -->
    <script src="https://cdn.jsdelivr.net/npm/bitcoinjs-lib@6.1.0/dist/bitcoinjs-lib.min.js"></script>
</body>
</html>
